/**
 * 2015.11.20更新：
 * 1、改成闭包，方便回调函数的使用；
 * 2、第一个参数若为回调函数，则是一个无皮肤的纯加载类，若传容器，就需要加上CSS，使用经典样式。
 * 2015.09.25 11:02 调整loadFiles方法，增加setProNum是否是function的判断，避免异常 * 
 */

/**
 * 创建一个进度条，初步版本：
 * 1、CSS没有脱离出来，需要手动添加；
 * 2、仅用于CREATJS版本，可以分离出其他版本。建议不写通用
 *
 * @param parent        父级容器（或回调函数，如果传div就是容器，传function就是回调）
 * @param bgSrc         进度条背景图
 * @param barSrc        进度条
 * @param hasNoTxt      是否显示百分比文本
 * @param top           顶部（横向默认居中）
 * @constructor
 */
(function(){
	var callback=null;
	window.LC_LoaderBar=function(parent,bgSrc,barSrc,hasNoTxt,top,back){
		if(typeof parent == 'function')
		{
			callback=parent;
		}else{
			var container=document.createElement('div');
		    container.id='loadPage';
		    container.className='pageBox';
		    this.hasNoTxt=hasNoTxt;
		    var t="<p id='LoadNum'></p>";
		    if(hasNoTxt){
		        t="";
		    }
		    container.innerHTML="<div id='loadw' style='margin: 70% auto 0 auto'>" +
		          "<img src='"+barSrc+"' id='loadn'> </div>"+t;
		    parent.appendChild(container);
		    var loadDiv=document.getElementById('loadw');
		    loadDiv.style.backgroundImage=bgSrc;
		    if(top){
		        loadDiv.style.marginTop=''+top+'px';
		    }
		}	    
	    this.loaded=null;
	    this.auto=true;
	}
	window.LC_LoaderBar.prototype={
	    set visible(b){
	        document.getElementById('loadPage').style.display=b?'block':'none';
	    },
	    set top(n){
	        document.getElementById('loadw').style.marginTop=''+n+'px';
	    },
	    get top(){
	        return document.getElementById('loadw').style.marginTop;
	    },
	    setProNum:function(n){
	    	if(callback){
	    		callback(n);
	    	}else{
	    		document.getElementById('loadn').style.width=n.toFixed(2)+'%';
	    		if(document.getElementById('LoadNum')) document.getElementById('LoadNum').innerHTML = '加载中...'+n.toFixed(2)+'%';
	    	}	        
	    },
	    /**
	     * 加载图片资源
	     * @param func          回调
	     * @param setProNum     this.setProNum
	     * @param arr           资源数组，为空就默认加载lib.properties.manifest
	     */
	    loadFiles:function(func,setProNum,arr){
//	    	var createjs=createjs||{};
            createjs;
	        var that=this;
	        if(!arr){
	            arr=lib.properties.manifest;
	        }
	        this.loader = new createjs.LoadQueue(false);
	        this.loader.addEventListener("fileload", handleFileLoad);
	        this.loader.addEventListener("complete", handleComplete);
	        images = images||{};
	        var loadNum=this.auto?50:0;
	        function handleFileLoad(evt) {
	            loadNum+=100/(arr.length);
	            
	            if(typeof(setProNum)=='function') setProNum(loadNum);
	            if (evt.item.type == "image") { images[evt.item.id] = evt.result; }
	        }
	
	        function handleComplete(){
	            //that.proNum=100;
	            
	            func();
	        }
	        this.loader.loadManifest(arr);
	    },
	    set loadedBack(func){
	        this.loaded=func;
	    },
	    /**
	     * 加载JS
	     * @param urls  JS相对地址的数组
	     * @param func  回调函数，具体值由auto决定
	     * @param auto  决定是否是自动加载图片，若是自动加载图片上边的回调函数就是指图片加载完之后调用，否则就是加载完JS调用
	     */
	    loadJsArr:function(urls,func,auto){
	        this.loaded=func;
	        this.auto=auto;
	        var that=this;
	        var loadAssets=this.loadFiles;
	        var len=urls.length;
	        var count= 0,loadNum=0;
	        var n=auto?2:1;
	        load();
	        function load(){
	            var _doc=document.getElementsByTagName('head')[0];
	            var script=document.createElement('script');
	            script.setAttribute('type','text/javascript');
	            script.setAttribute('src',urls[count]);
	            _doc.appendChild(script);
	            script.onload=script.onreadystatechange=function(){
	                if(!this.readyState||this.readyState=='loaded'||this.readyState=='complete'){
	                    count++;
	                    loadNum=(count+1)/len*100/n;
	                    that.setProNum(loadNum);
	                    if(count==len)
	                    {
	                        if(auto) loadAssets(func,that.setProNum);
	                        else func();
	                    }else{
	                        load();
	                    }
	                }
	                script.onload=script.onreadystatechange=null;
	            }
	        }
	    }
	}
})();